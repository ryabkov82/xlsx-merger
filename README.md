# xlsx-merger

`xlsx-merger` — это утилита на Go для объединения множества Excel-файлов (`.xlsx`) в один или несколько выходных файлов с сохранением:

- стилей ячеек (шрифтов, форматов чисел, выравнивания и т.д.)
- ширины колонок и высоты строк
- правильных типов данных (числа, строки, булевы и даты)
- автоматического определения форматов чисел

Поддерживается разбиение результата на несколько файлов, если число строк превышает заданное ограничение (`--max-row`).

---

## Особенности

- Использует `excelize.StreamWriter` для работы с большими XLSX
- Поддержка нескольких выходных файлов при превышении `--max-row`
- Сохранение форматирования из шаблона (указанного через `--template` или автоматически выбранного по самому большому файлу)
- Автоматическое определение и сохранение форматов чисел с нужным числом знаков после запятой
- Поддержка добавления имени исходного файла в конец строки

---

## Установка и сборка

**Требуется:** Go 1.19+

```bash
go build -o xlsx-merger main.go
```

**Справка:**

```bash
./xlsx-merger --help
```

---

## Использование из Go

```go
err := sm.MergeFiles(&config.Config{
    InputDir:       "./input",
    OutputPath:     "./output/merged.xlsx",
    MaxRowPerFile:  600000,
    HasHeaders:     true,
    AddSourceFile:  true,
    TemplatePath:   "./input/template.xlsx", // путь к шаблону (опционально)
})
```

---

## Использование из командной строки

```bash
./xlsx-merger   --dir ./testdata   --out ./merged/output.xlsx   --sample 50   --add-source=true   --has-headers=true   --max-row 600000   --template ./testdata/template.xlsx
```

---

## Параметры командной строки

| Ключ            | Описание                                          |
|-----------------|---------------------------------------------------|
| `--dir`         | Папка с исходными `.xlsx` файлами                 |
| `--out`         | Базовое имя выходного файла                       |
| `--sample`      | Число строк для анализа стилей                    |
| `--add-source`  | Добавлять имя исходного файла в последний столбец |
| `--has-headers` | Заголовки присутствуют в исходных файлах          |
| `--max-row`     | Макс. число строк в одном выходном файле          |
| `--template`    | Путь к XLSX-файлу-шаблону (опционально)           |

---

## Формат вывода (JSON)

Результаты работы утилиты выводятся в формате JSON. Это удобно для дальнейшей автоматической обработки.

### Пример успешного результата:

```json
{
  "success": true,
  "output_files": [
    "merged_part1.xlsx",
    "merged_part2.xlsx"
  ],
  "duration": "3.42s",
  "row_count": 1189345
}
```

### Пример с ошибкой:

```json
{
  "success": false,
  "error": "Ошибка конфигурации: входная папка не найдена",
  "duration": "12.3ms"
}
```

### Структура JSON:

| Поле           | Тип        | Описание                                                                 |
| -------------- | ---------- | ------------------------------------------------------------------------ |
| `success`      | `bool`     | `true`, если операция завершилась успешно, иначе `false`.                |
| `output_files` | `[]string` | Список сгенерированных файлов, если объединение прошло успешно.          |
| `error`        | `string`   | Сообщение об ошибке (только если `success = false`).                     |
| `duration`     | `string`   | Время выполнения операции (например, `"3.42s"`, `"250ms"`).              |
| `row_count`    | `int64`    | Общее количество строк, записанных в выходные файлы (только при успехе). |


> JSON-вывод производится в `stdout` и может быть перенаправлен в файл или обработан скриптом.

---

## Требования

- Go 1.19+
- [github.com/xuri/excelize/v2](https://github.com/xuri/excelize)

---

## Лицензия

MIT
